var Yt=Object.defineProperty;var wt=(t,e,n)=>e in t?Yt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var at=(t,e,n)=>wt(t,typeof e!="symbol"?e+"":e,n);import"./style-WLU6Igt5.js";class kt{constructor(e){at(this,"state");at(this,"spare",null);this.state=e>>>0||1}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967296}uniform(e,n){return e+(n-e)*this.next()}normal(e=0,n=1){if(this.spare!==null){const g=this.spare;return this.spare=null,e+n*g}let s=0,i=0;for(;s<=Number.EPSILON;)s=this.next();for(;i<=Number.EPSILON;)i=this.next();const c=Math.sqrt(-2*Math.log(s)),y=c*Math.cos(2*Math.PI*i),d=c*Math.sin(2*Math.PI*i);return this.spare=d,e+n*y}}const k={T:1e3,dt:1,numParticles:200,type0Fraction:.5,boxWidth:100,boxHeight:100,wallThickness:4,diffusionSd:.5,electricStrength:.1,repulsionStrength:.05,negX:-30,negY:0,type0YMin:30,type0YMax:31,type1YMin:-40,type1YMax:-10},D={pointSize:2.2,playbackSpeed:1,targetFps:30};function o(t,e,n){return Math.min(n,Math.max(e,t))}function lt(){return Math.random()*4294967295>>>0}function ct(t,e,n){const s=n/2,i=o(Math.min(t,e),-s,s),c=o(Math.max(t,e),-s,s);return c-i<.5?[i,Math.min(s,i+.5)]:[i,c]}function l(t){const e=document.querySelector(t);if(!e)throw new Error(`Missing ${t}`);return e}function u(t,e,n=3){t.value=Number.isInteger(e)?String(e):Number(e.toFixed(n)).toString()}function ut(t,e){const n=o(Math.round(t.T),20,2e4),s=o(t.dt,.05,20),i=o(Math.round(t.numParticles),1,500),c=o(t.type0Fraction,0,1),y=o(t.boxWidth,20,500),d=o(t.boxHeight,20,500),g=o(t.wallThickness,.5,Math.min(50,y-2)),x=o(t.diffusionSd,0,20),v=o(t.electricStrength,0,10),L=o(t.repulsionStrength,0,10),[H,T]=ct(t.type0YMin,t.type0YMax,d),[M,_]=ct(t.type1YMin,t.type1YMax,d),S=-g/2,m=g/2,N=o(t.negX,-y/2,y/2),j=o(t.negY,-d/2,d/2),E=Math.max(2,Math.floor(n/s)),z=new Float32Array(E*i),I=new Float32Array(E*i),et=new Uint8Array(i),B=new kt(e);for(let Y=0;Y<i;Y+=1)et[Y]=B.next()<c?0:1,z[Y]=B.uniform(m+1,y/2-1),I[Y]=B.uniform(-d/2+1,d/2-1);const nt=new Float32Array(i),it=new Float32Array(i);for(let Y=1;Y<E;Y+=1){const X=(Y-1)*i,rt=Y*i;nt.fill(0),it.fill(0);for(let f=0;f<i;f+=1){const R=z[X+f],q=I[X+f];let G=0,O=0;for(let P=0;P<i;P+=1){if(P===f)continue;const W=R-z[X+P],A=q-I[X+P],U=1/(W*W+A*A+.001);G+=W*U,O+=A*U}nt[f]=L*G,it[f]=L*O}for(let f=0;f<i;f+=1){const R=z[X+f],q=I[X+f],G=B.normal(0,x),O=B.normal(0,x),P=N-R,W=j-q,A=Math.sqrt(P*P+W*W)+.001,dt=v*P/A,U=v*W/A;let K=R+(G+dt+nt[f])*s;const bt=o(q+(O+U+it[f])*s,-d/2,d/2),mt=R>m&&K<=m,xt=R<S&&K>=S,pt=et[f],vt=pt===0?H:M,Mt=pt===0?T:_,St=q>=vt&&q<=Mt;(mt||xt)&&!St&&(K=R),z[rt+f]=K,I[rt+f]=bt}}return{x:z,y:I,types:et,frames:E,numParticles:i,dt:s,boxWidth:y,boxHeight:d,leftWall:S,rightWall:m,negX:N,negY:j,type0YMin:H,type0YMax:T,type1YMin:M,type1YMax:_}}function Tt(t){const e=window.devicePixelRatio||1,n=t.getBoundingClientRect(),s=Math.max(1,Math.round(n.width*e)),i=Math.max(1,Math.round(n.height*e));(t.width!==s||t.height!==i)&&(t.width=s,t.height=i)}function h(t,e,n,s,i){return[(t+n.boxWidth/2)/n.boxWidth*s,i-(e+n.boxHeight/2)/n.boxHeight*i]}function Pt(t,e,n,s,i){t.fillStyle="#03060b",t.fillRect(0,0,n,s),t.strokeStyle="rgba(120,170,255,0.10)",t.lineWidth=1;for(let T=1;T<10;T+=1){const M=n*T/10,_=s*T/10;t.beginPath(),t.moveTo(M,0),t.lineTo(M,s),t.stroke(),t.beginPath(),t.moveTo(0,_),t.lineTo(n,_),t.stroke()}const[c]=h(e.leftWall,0,e,n,s),[y]=h(e.rightWall,0,e,n,s);t.fillStyle="rgba(200,220,255,0.08)",t.fillRect(c,0,y-c,s);const[,d]=h(0,e.type0YMax,e,n,s),[,g]=h(0,e.type0YMin,e,n,s),[,x]=h(0,e.type1YMax,e,n,s),[,v]=h(0,e.type1YMin,e,n,s);t.fillStyle="rgba(245,178,72,0.14)",t.fillRect(c,d,y-c,g-d),t.fillStyle="rgba(66,200,255,0.14)",t.fillRect(c,x,y-c,v-x),t.strokeStyle="rgba(190,225,255,0.48)",t.lineWidth=1.5*i;for(const T of[e.leftWall,e.rightWall]){const[M]=h(T,0,e,n,s),_=[[e.type0YMin,e.type0YMax],[e.type1YMin,e.type1YMax]].sort((m,N)=>m[0]-N[0]);let S=-e.boxHeight/2;for(const[m,N]of _){if(m>S){const[,j]=h(0,S,e,n,s),[,E]=h(0,m,e,n,s);t.beginPath(),t.moveTo(M,j),t.lineTo(M,E),t.stroke()}S=Math.max(S,N)}if(S<e.boxHeight/2){const[,m]=h(0,S,e,n,s),[,N]=h(0,e.boxHeight/2,e,n,s);t.beginPath(),t.moveTo(M,m),t.lineTo(M,N),t.stroke()}}const[L,H]=h(e.negX,e.negY,e,n,s);t.fillStyle="rgba(255,96,96,0.95)",t.beginPath(),t.arc(L,H,4*i,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(120,170,255,0.2)",t.lineWidth=1*i,t.strokeRect(.5*i,.5*i,n-i,s-i)}function J(t,e,n,s){Tt(t);const i=t.getContext("2d");if(!i)return;const c=t.width,y=t.height,d=window.devicePixelRatio||1;i.clearRect(0,0,c,y),Pt(i,e,c,y,d);const g=o(n,0,e.frames-1)*e.numParticles,x=Math.max(.8,s.pointSize)*d;for(let v=0;v<e.numParticles;v+=1){const[L,H]=h(e.x[g+v],e.y[g+v],e,c,y);i.fillStyle=e.types[v]===0?"rgba(245,178,72,0.92)":"rgba(66,200,255,0.92)",i.beginPath(),i.arc(L,H,x,0,Math.PI*2),i.fill()}i.fillStyle="rgba(232,243,255,0.92)",i.font=`${12*d}px Avenir Next, Segoe UI, sans-serif`,i.fillText("Selective Channels + Repulsion + Gradient",12*d,20*d)}function Ft(t,e){const n=o(e,0,t.frames-1)*t.numParticles;let s=0,i=0,c=0,y=0;for(let d=0;d<t.numParticles;d+=1){const g=t.x[n+d],x=t.types[d];g<t.leftWall?x===0?s+=1:c+=1:g>t.rightWall&&(x===0?i+=1:y+=1)}return{type0Left:s,type0Right:i,type1Left:c,type1Right:y}}const Nt=l("#app");Nt.innerHTML=`
  <div class="site-shell">
    <div class="nav-line"><a href="./index.html">Back to index</a><span>•</span><span>Page: <code>inspect_electrochemical_3</code></span></div>
    <header class="page-head">
      <p class="eyebrow">Adding Electrical and Interaction Forces</p>
      <h1>inspect_electrochemical_3</h1>
      <p class="subtitle">Selective-channel electro-diffusion with repulsion toward a fixed negative attractor.</p>
    </header>
    <div class="sim-layout">
      <aside class="controls">
        <div class="panel">
          <div class="group">
            <p class="group-label">Basic Controls</p>
            <div class="button-row"><button id="toggle-play" class="primary">Pause</button><button id="rerun">Rerun</button><button id="reset-defaults" class="warn">Reset Defaults</button></div>
            <div class="button-row"><button id="rewind">Rewind</button><button id="random-seed">Randomize Seed</button></div>
            <div class="control-grid">
              <div class="field"><label for="num-particles">Particles</label><input id="num-particles" type="number" min="1" max="500" step="1" /></div>
              <div class="field"><label for="type0-fraction">Type 0 fraction</label><input id="type0-fraction" type="number" min="0" max="1" step="0.01" /></div>
              <div class="field"><label for="diffusion-sd">Diffusion SD</label><input id="diffusion-sd" type="number" min="0" max="20" step="0.05" /></div>
              <div class="field"><label for="electric-strength">Electric strength</label><input id="electric-strength" type="number" min="0" max="10" step="0.01" /></div>
              <div class="field"><label for="repulsion-strength">Repulsion strength</label><input id="repulsion-strength" type="number" min="0" max="10" step="0.01" /></div>
              <div class="field"><label for="type0-y-min">Type 0 y min</label><input id="type0-y-min" type="number" step="0.5" /></div>
              <div class="field"><label for="type0-y-max">Type 0 y max</label><input id="type0-y-max" type="number" step="0.5" /></div>
              <div class="field"><label for="type1-y-min">Type 1 y min</label><input id="type1-y-min" type="number" step="0.5" /></div>
              <div class="field"><label for="type1-y-max">Type 1 y max</label><input id="type1-y-max" type="number" step="0.5" /></div>
              <div class="field"><label for="playback-speed">Playback speed</label><input id="playback-speed" type="number" min="0.1" max="8" step="0.1" /></div>
              <div class="field"><label for="seed">Seed</label><input id="seed" type="number" min="0" max="4294967295" step="1" /></div>
            </div>
          </div>
          <details><summary>Advanced Controls</summary><div class="group" style="margin-top:8px;"><div class="control-grid">
            <div class="field"><label for="total-time">Total time T (ms)</label><input id="total-time" type="number" min="20" max="20000" step="10" /></div>
            <div class="field"><label for="dt">dt (ms)</label><input id="dt" type="number" min="0.05" max="20" step="0.05" /></div>
            <div class="field"><label for="box-width">Box width</label><input id="box-width" type="number" min="20" max="500" step="1" /></div>
            <div class="field"><label for="box-height">Box height</label><input id="box-height" type="number" min="20" max="500" step="1" /></div>
            <div class="field"><label for="wall-thickness">Wall thickness</label><input id="wall-thickness" type="number" min="0.5" max="50" step="0.5" /></div>
            <div class="field"><label for="neg-x">Neg attractor x</label><input id="neg-x" type="number" step="1" /></div>
            <div class="field"><label for="neg-y">Neg attractor y</label><input id="neg-y" type="number" step="1" /></div>
            <div class="field"><label for="point-size">Point size</label><input id="point-size" type="number" min="0.5" max="8" step="0.25" /></div>
            <div class="field"><label for="target-fps">Playback FPS</label><input id="target-fps" type="number" min="1" max="120" step="1" /></div>
          </div></div></details>
          <div class="group"><p class="group-label">Status</p><dl class="status-list">
            <dt>Frame</dt><dd id="status-frame">0</dd><dt>Time (ms)</dt><dd id="status-time">0.0</dd>
            <dt>Type 0 Left</dt><dd id="status-type0-left">0</dd><dt>Type 0 Right</dt><dd id="status-type0-right">0</dd>
            <dt>Type 1 Left</dt><dd id="status-type1-left">0</dd><dt>Type 1 Right</dt><dd id="status-type1-right">0</dd>
            <dt>dt</dt><dd id="status-dt">0</dd><dt>Step SD</dt><dd id="status-step-sd">0</dd>
            <dt>Seed</dt><dd id="status-seed">0</dd><dt>Frames total</dt><dd id="status-frames">0</dd>
          </dl></div>
          <div class="group"><p class="group-label">Equation + Selective Electro-Diffusion</p><div class="equation-card"><pre class="equation" id="equation-block"></pre>
            <p>All particles share diffusion, drift, and repulsion dynamics, but each type has a different channel gating window.</p>
          </div></div>
        </div>
      </aside>
      <section class="panel canvas-panel">
        <div class="canvas-head"><h2>Selective Channels + Repulsion + Gradient</h2><span class="tiny">Qualitative browser port of <code>inspect_electrochemical_3.py</code></span></div>
        <canvas id="sim-canvas" aria-label="Selective channel electrochemical simulation"></canvas>
        <div class="legend">
          <span><span class="swatch" style="background:#f5b248"></span>Type 0</span>
          <span><span class="swatch" style="background:#42c8ff"></span>Type 1</span>
          <span><span class="swatch" style="background:#ff6060"></span>Negative attractor</span>
        </div>
      </section>
    </div>
  </div>
`;const V=l("#sim-canvas"),_t=l("#equation-block"),a={numParticles:l("#num-particles"),type0Fraction:l("#type0-fraction"),diffusionSd:l("#diffusion-sd"),electricStrength:l("#electric-strength"),repulsionStrength:l("#repulsion-strength"),type0YMin:l("#type0-y-min"),type0YMax:l("#type0-y-max"),type1YMin:l("#type1-y-min"),type1YMax:l("#type1-y-max"),playbackSpeed:l("#playback-speed"),seed:l("#seed"),totalTime:l("#total-time"),dt:l("#dt"),boxWidth:l("#box-width"),boxHeight:l("#box-height"),wallThickness:l("#wall-thickness"),negX:l("#neg-x"),negY:l("#neg-y"),pointSize:l("#point-size"),targetFps:l("#target-fps")},w={frame:l("#status-frame"),time:l("#status-time"),type0Left:l("#status-type0-left"),type0Right:l("#status-type0-right"),type1Left:l("#status-type1-left"),type1Right:l("#status-type1-right"),dt:l("#status-dt"),stepSd:l("#status-step-sd"),seed:l("#status-seed"),frames:l("#status-frames")},$={togglePlay:l("#toggle-play"),rerun:l("#rerun"),resetDefaults:l("#reset-defaults"),rewind:l("#rewind"),randomSeed:l("#random-seed")};let r={...k},b={...D},F=lt(),p=ut(r,F),Q=!0,C=0,st=performance.now();function Z(){u(a.numParticles,r.numParticles,0),u(a.type0Fraction,r.type0Fraction,2),u(a.diffusionSd,r.diffusionSd,3),u(a.electricStrength,r.electricStrength,3),u(a.repulsionStrength,r.repulsionStrength,3),u(a.type0YMin,r.type0YMin,2),u(a.type0YMax,r.type0YMax,2),u(a.type1YMin,r.type1YMin,2),u(a.type1YMax,r.type1YMax,2),u(a.playbackSpeed,b.playbackSpeed,2),u(a.seed,F,0),u(a.totalTime,r.T,0),u(a.dt,r.dt,3),u(a.boxWidth,r.boxWidth,1),u(a.boxHeight,r.boxHeight,1),u(a.wallThickness,r.wallThickness,2),u(a.negX,r.negX,1),u(a.negY,r.negY,1),u(a.pointSize,b.pointSize,2),u(a.targetFps,b.targetFps,0)}function Rt(){const t=o(Number(a.boxHeight.value)||k.boxHeight,20,500),e=o(Number(a.boxWidth.value)||k.boxWidth,20,500);return{T:o(Number(a.totalTime.value)||k.T,20,2e4),dt:o(Number(a.dt.value)||k.dt,.05,20),numParticles:o(Math.round(Number(a.numParticles.value)||k.numParticles),1,500),type0Fraction:o(Number(a.type0Fraction.value)||0,0,1),boxWidth:e,boxHeight:t,wallThickness:o(Number(a.wallThickness.value)||k.wallThickness,.5,50),diffusionSd:o(Number(a.diffusionSd.value)||0,0,20),electricStrength:o(Number(a.electricStrength.value)||0,0,10),repulsionStrength:o(Number(a.repulsionStrength.value)||0,0,10),negX:o(Number(a.negX.value)||k.negX,-e/2,e/2),negY:o(Number(a.negY.value)||k.negY,-t/2,t/2),type0YMin:o(Number(a.type0YMin.value)||0,-t/2,t/2),type0YMax:o(Number(a.type0YMax.value)||0,-t/2,t/2),type1YMin:o(Number(a.type1YMin.value)||0,-t/2,t/2),type1YMax:o(Number(a.type1YMax.value)||0,-t/2,t/2)}}function yt(){return{pointSize:o(Number(a.pointSize.value)||D.pointSize,.5,8),playbackSpeed:o(Number(a.playbackSpeed.value)||D.playbackSpeed,.1,8),targetFps:o(Math.round(Number(a.targetFps.value)||D.targetFps),1,120)}}function ft(){const t=r.diffusionSd*r.dt,e=r.type0YMax-r.type0YMin,n=r.type1YMax-r.type1YMin;_t.innerHTML=['<span class="accent">Euler electro-diffusion + repulsion (all particles)</span>',"attract = electric_strength · (neg_pos - pos) / (||neg_pos - pos|| + ε)","repel_j = repulsion_strength · Σ_k≠j (pos_j - pos_k) / (||pos_j - pos_k||² + ε)","x_new = x_old + (dxdt + attract_x + repel_x) · dt","y_new = clamp(y_old + (dydt + attract_y + repel_y) · dt, -H/2, H/2)","dxdt, dydt ~ Normal(0, diffusionSd²)","",'<span class="accent-2">Type-selective membrane rule</span>',"type 0 uses [type0_y_min, type0_y_max]; type 1 uses [type1_y_min, type1_y_max]","If wall crossing attempted outside that type channel -> x_new := x_old","",`Per-step Brownian displacement SD = diffusionSd × dt = ${t.toFixed(3)}`,`Channel widths (type0/type1) = ${e.toFixed(1)} / ${n.toFixed(1)}`].join(`
`)}function ot(t){const e=Ft(p,t);w.frame.textContent=`${t+1}`,w.time.textContent=(t*p.dt).toFixed(1),w.type0Left.textContent=`${e.type0Left}`,w.type0Right.textContent=`${e.type0Right}`,w.type1Left.textContent=`${e.type1Left}`,w.type1Right.textContent=`${e.type1Right}`,w.dt.textContent=p.dt.toFixed(2),w.stepSd.textContent=(r.diffusionSd*r.dt).toFixed(3),w.seed.textContent=`${F>>>0}`,w.frames.textContent=`${p.frames}`}function tt(t=!0){r=Rt(),b=yt(),F=o(Math.floor(Number(a.seed.value)||F),0,4294967295)>>>0,p=ut(r,F),r={...r,boxWidth:p.boxWidth,boxHeight:p.boxHeight,wallThickness:p.rightWall-p.leftWall,negX:p.negX,negY:p.negY,type0YMin:p.type0YMin,type0YMax:p.type0YMax,type1YMin:p.type1YMin,type1YMax:p.type1YMax},t&&(C=0),Z(),ft()}function Wt(){b=yt(),Z()}function ht(t){Q=t,$.togglePlay.textContent=Q?"Pause":"Play"}Z();ft();ot(0);J(V,p,0,b);$.togglePlay.addEventListener("click",()=>ht(!Q));$.rerun.addEventListener("click",()=>tt(!0));$.rewind.addEventListener("click",()=>{C=0,ot(0),J(V,p,0,b)});$.randomSeed.addEventListener("click",()=>{F=lt(),u(a.seed,F,0),tt(!0)});$.resetDefaults.addEventListener("click",()=>{r={...k},b={...D},F=lt(),Z(),tt(!0),ht(!0)});const Ct=["numParticles","type0Fraction","diffusionSd","electricStrength","repulsionStrength","type0YMin","type0YMax","type1YMin","type1YMax","seed","totalTime","dt","boxWidth","boxHeight","wallThickness","negX","negY"];for(const t of Ct)a[t].addEventListener("change",()=>tt(t!=="seed"));for(const t of["playbackSpeed","pointSize","targetFps"])a[t].addEventListener("change",()=>Wt());window.addEventListener("resize",()=>J(V,p,Math.floor(C),b));function gt(t){const e=(t-st)/1e3;st=t,Q&&p.frames>0&&(C+=e*b.targetFps*b.playbackSpeed,C>=p.frames&&(C%=p.frames));const n=o(Math.floor(C),0,Math.max(0,p.frames-1));ot(n),J(V,p,n,b),requestAnimationFrame(gt)}requestAnimationFrame(t=>{st=t,gt(t)});
