var ge=Object.defineProperty;var be=(t,e,s)=>e in t?ge(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var ee=(t,e,s)=>be(t,typeof e!="symbol"?e+"":e,s);import"./style-WLU6Igt5.js";class me{constructor(e){ee(this,"state");ee(this,"spare",null);this.state=e>>>0||1}next(){let e=this.state;return e^=e<<13,e^=e>>>17,e^=e<<5,this.state=e>>>0,this.state/4294967296}uniform(e,s){return e+(s-e)*this.next()}normal(e=0,s=1){if(this.spare!==null){const S=this.spare;return this.spare=null,e+s*S}let c=0,n=0;for(;c<=Number.EPSILON;)c=this.next();for(;n<=Number.EPSILON;)n=this.next();const o=Math.sqrt(-2*Math.log(c)),r=o*Math.cos(2*Math.PI*n),x=o*Math.sin(2*Math.PI*n);return this.spare=x,e+s*r}}const v={T:1e3,dt:1,numParticles:100,boxWidth:100,boxHeight:60,wallThickness:4,diffusionSd:.5,channelYMin:-10,channelYMax:10,electricStrength:.3,repulsionStrength:.2,negX:-35,negY:0},q={pointSize:2.4,playbackSpeed:1,targetFps:30};function l(t,e,s){return Math.min(s,Math.max(e,t))}function xe(t,e,s){const c=s/2,n=l(Math.min(t,e),-c,c),o=l(Math.max(t,e),-c,c);return o-n<.5?[n,Math.min(c,n+.5)]:[n,o]}function ne(){return Math.random()*4294967295>>>0}function a(t){const e=document.querySelector(t);if(!e)throw new Error(`Missing ${t}`);return e}function h(t,e,s=3){t.value=Number.isInteger(e)?String(e):Number(e.toFixed(s)).toString()}function se(t,e){const s=l(Math.round(t.T),20,2e4),c=l(t.dt,.05,20),n=l(Math.round(t.numParticles),1,1e3),o=l(t.boxWidth,20,500),r=l(t.boxHeight,20,500),x=l(t.wallThickness,.5,Math.min(50,o-2)),S=l(t.diffusionSd,0,20),R=l(t.electricStrength,0,10),X=l(t.repulsionStrength,0,10),[D,B]=xe(t.channelYMin,t.channelYMax,r),I=-x/2,Y=x/2,$=l(t.negX,-o/2,o/2),f=l(t.negY,-r/2,r/2),g=Math.max(2,Math.floor(s/c)),b=new Float32Array(g*n),P=new Float32Array(g*n),W=new me(e);for(let w=0;w<n;w+=1)b[w]=W.uniform(Y+1,o/2-1),P[w]=W.uniform(-r/2+1,r/2-1);const L=new Float32Array(n),Z=new Float32Array(n);for(let w=1;w<g;w+=1){const C=(w-1)*n,le=w*n;L.fill(0),Z.fill(0);for(let p=0;p<n;p+=1){const _=b[C+p],E=P[C+p];let A=0,j=0;for(let M=0;M<n;M+=1){if(M===p)continue;const N=_-b[C+M],H=E-P[C+M],O=1/(N*N+H*H+.001);A+=N*O,j+=H*O}L[p]=X*A,Z[p]=X*j}for(let p=0;p<n;p+=1){const _=b[C+p],E=P[C+p],A=W.normal(0,S),j=W.normal(0,S),M=$-_,N=f-E,H=Math.sqrt(M*M+N*N)+.001,ae=R*M/H,O=R*N/H;let G=_+(A+ae+L[p])*c;const ue=l(E+(j+O+Z[p])*c,-r/2,r/2),he=_>Y&&G<=Y,pe=_<I&&G>=I,fe=E>=D&&E<=B;(he||pe)&&!fe&&(G=_),b[le+p]=G,P[le+p]=ue}}return{x:b,y:P,frames:g,numParticles:n,dt:c,boxWidth:o,boxHeight:r,leftWall:I,rightWall:Y,channelYMin:D,channelYMax:B,negX:$,negY:f}}function ye(t){const e=window.devicePixelRatio||1,s=t.getBoundingClientRect(),c=Math.max(1,Math.round(s.width*e)),n=Math.max(1,Math.round(s.height*e));(t.width!==c||t.height!==n)&&(t.width=c,t.height=n)}function y(t,e,s,c,n){return[(t+s.boxWidth/2)/s.boxWidth*c,n-(e+s.boxHeight/2)/s.boxHeight*n]}function Q(t,e,s,c){ye(t);const n=t.getContext("2d");if(!n)return;const o=t.width,r=t.height,x=window.devicePixelRatio||1;n.clearRect(0,0,o,r),n.fillStyle="#03060b",n.fillRect(0,0,o,r),n.strokeStyle="rgba(120,170,255,0.10)",n.lineWidth=1;for(let f=1;f<10;f+=1){const g=o*f/10,b=r*f/10;n.beginPath(),n.moveTo(g,0),n.lineTo(g,r),n.stroke(),n.beginPath(),n.moveTo(0,b),n.lineTo(o,b),n.stroke()}const[S]=y(e.leftWall,0,e,o,r),[R]=y(e.rightWall,0,e,o,r),[,X]=y(0,e.channelYMax,e,o,r),[,D]=y(0,e.channelYMin,e,o,r);n.fillStyle="rgba(200,220,255,0.08)",n.fillRect(S,0,R-S,r),n.fillStyle="rgba(159,255,106,0.10)",n.fillRect(S,X,R-S,D-X),n.strokeStyle="rgba(190,225,255,0.45)",n.lineWidth=1.5*x;for(const f of[e.leftWall,e.rightWall]){const[g]=y(f,0,e,o,r),[,b]=y(0,e.boxHeight/2,e,o,r),[,P]=y(0,e.channelYMax,e,o,r),[,W]=y(0,e.channelYMin,e,o,r),[,L]=y(0,-e.boxHeight/2,e,o,r);n.beginPath(),n.moveTo(g,b),n.lineTo(g,P),n.moveTo(g,W),n.lineTo(g,L),n.stroke()}const[B,I]=y(e.negX,e.negY,e,o,r);n.fillStyle="rgba(66,200,255,0.95)",n.beginPath(),n.arc(B,I,4*x,0,Math.PI*2),n.fill();const Y=l(s,0,e.frames-1)*e.numParticles,$=Math.max(.8,c.pointSize)*x;n.fillStyle="rgba(245,178,72,0.92)";for(let f=0;f<e.numParticles;f+=1){const[g,b]=y(e.x[Y+f],e.y[Y+f],e,o,r);n.beginPath(),n.arc(g,b,$,0,Math.PI*2),n.fill()}n.fillStyle="rgba(232,243,255,0.92)",n.font=`${12*x}px Avenir Next, Segoe UI, sans-serif`,n.fillText("Repulsion + Electrical Gradient Through Channel",12*x,20*x)}function ve(t,e){const s=l(e,0,t.frames-1)*t.numParticles;let c=0,n=0;for(let o=0;o<t.numParticles;o+=1){const r=t.x[s+o];r<t.leftWall?c+=1:r>t.rightWall&&(n+=1)}return{left:c,right:n}}const Se=a("#app");Se.innerHTML=`
  <div class="site-shell">
    <div class="nav-line"><a href="./index.html">Back to index</a><span>•</span><span>Page: <code>inspect_electrochemical_2</code></span></div>
    <header class="page-head">
      <p class="eyebrow">Adding Electrical and Interaction Forces</p>
      <h1>inspect_electrochemical_2</h1>
      <p class="subtitle">Electrically biased diffusion through a channel with particle-particle repulsion (crowding term).</p>
    </header>
    <div class="sim-layout">
      <aside class="controls">
        <div class="panel">
          <div class="group">
            <p class="group-label">Basic Controls</p>
            <div class="button-row"><button id="toggle-play" class="primary">Pause</button><button id="rerun">Rerun</button><button id="reset-defaults" class="warn">Reset Defaults</button></div>
            <div class="button-row"><button id="rewind">Rewind</button><button id="random-seed">Randomize Seed</button></div>
            <div class="control-grid">
              <div class="field"><label for="num-particles">Particles</label><input id="num-particles" type="number" min="1" max="1000" step="1" /></div>
              <div class="field"><label for="diffusion-sd">Diffusion SD</label><input id="diffusion-sd" type="number" min="0" max="20" step="0.05" /></div>
              <div class="field"><label for="electric-strength">Electric strength</label><input id="electric-strength" type="number" min="0" max="10" step="0.01" /></div>
              <div class="field"><label for="repulsion-strength">Repulsion strength</label><input id="repulsion-strength" type="number" min="0" max="10" step="0.01" /></div>
              <div class="field"><label for="channel-y-min">Channel y min</label><input id="channel-y-min" type="number" step="0.5" /></div>
              <div class="field"><label for="channel-y-max">Channel y max</label><input id="channel-y-max" type="number" step="0.5" /></div>
              <div class="field"><label for="playback-speed">Playback speed</label><input id="playback-speed" type="number" min="0.1" max="8" step="0.1" /></div>
              <div class="field"><label for="seed">Seed</label><input id="seed" type="number" min="0" max="4294967295" step="1" /></div>
            </div>
          </div>
          <details><summary>Advanced Controls</summary><div class="group" style="margin-top:8px;"><div class="control-grid">
            <div class="field"><label for="total-time">Total time T (ms)</label><input id="total-time" type="number" min="20" max="20000" step="10" /></div>
            <div class="field"><label for="dt">dt (ms)</label><input id="dt" type="number" min="0.05" max="20" step="0.05" /></div>
            <div class="field"><label for="box-width">Box width</label><input id="box-width" type="number" min="20" max="500" step="1" /></div>
            <div class="field"><label for="box-height">Box height</label><input id="box-height" type="number" min="20" max="500" step="1" /></div>
            <div class="field"><label for="wall-thickness">Wall thickness</label><input id="wall-thickness" type="number" min="0.5" max="50" step="0.5" /></div>
            <div class="field"><label for="neg-x">Neg charge x</label><input id="neg-x" type="number" step="1" /></div>
            <div class="field"><label for="neg-y">Neg charge y</label><input id="neg-y" type="number" step="1" /></div>
            <div class="field"><label for="point-size">Point size</label><input id="point-size" type="number" min="0.5" max="8" step="0.25" /></div>
            <div class="field"><label for="target-fps">Playback FPS</label><input id="target-fps" type="number" min="1" max="120" step="1" /></div>
          </div></div></details>
          <div class="group"><p class="group-label">Status</p><dl class="status-list">
            <dt>Frame</dt><dd id="status-frame">0</dd><dt>Time (ms)</dt><dd id="status-time">0.0</dd>
            <dt>Left</dt><dd id="status-left">0</dd><dt>Right</dt><dd id="status-right">0</dd>
            <dt>dt</dt><dd id="status-dt">0</dd><dt>Step SD</dt><dd id="status-step-sd">0</dd>
            <dt>Seed</dt><dd id="status-seed">0</dd><dt>Frames total</dt><dd id="status-frames">0</dd>
          </dl></div>
          <div class="group"><p class="group-label">Equation + Force Terms</p><div class="equation-card"><pre class="equation" id="equation-block"></pre>
            <p>Brownian motion and electric drift are combined with a pairwise repulsion term (O(N²) in this implementation).</p>
          </div></div>
        </div>
      </aside>
      <section class="panel canvas-panel">
        <div class="canvas-head"><h2>Single-Channel Electro-Diffusion With Repulsion</h2><span class="tiny">Qualitative browser port of <code>inspect_electrochemical_2.py</code></span></div>
        <canvas id="sim-canvas" aria-label="Electrochemical diffusion with repulsion"></canvas>
        <div class="legend"><span><span class="swatch" style="background:#f5b248"></span>Particles</span><span><span class="swatch" style="background:#42c8ff"></span>Negative attractor</span><span><span class="swatch" style="background:#9fff6a"></span>Open channel</span></div>
      </section>
    </div>
  </div>
`;const U=a("#sim-canvas"),we=a("#equation-block"),i={numParticles:a("#num-particles"),diffusionSd:a("#diffusion-sd"),electricStrength:a("#electric-strength"),repulsionStrength:a("#repulsion-strength"),channelYMin:a("#channel-y-min"),channelYMax:a("#channel-y-max"),playbackSpeed:a("#playback-speed"),seed:a("#seed"),totalTime:a("#total-time"),dt:a("#dt"),boxWidth:a("#box-width"),boxHeight:a("#box-height"),wallThickness:a("#wall-thickness"),negX:a("#neg-x"),negY:a("#neg-y"),pointSize:a("#point-size"),targetFps:a("#target-fps")},T={frame:a("#status-frame"),time:a("#status-time"),left:a("#status-left"),right:a("#status-right"),dt:a("#status-dt"),stepSd:a("#status-step-sd"),seed:a("#status-seed"),frames:a("#status-frames")},z={togglePlay:a("#toggle-play"),rerun:a("#rerun"),resetDefaults:a("#reset-defaults"),rewind:a("#rewind"),randomSeed:a("#random-seed")};let d={...v},m={...q},k=ne(),u=se(d,k),K=!0,F=0,te=performance.now();function J(){h(i.numParticles,d.numParticles,0),h(i.diffusionSd,d.diffusionSd,3),h(i.electricStrength,d.electricStrength,3),h(i.repulsionStrength,d.repulsionStrength,3),h(i.channelYMin,d.channelYMin,2),h(i.channelYMax,d.channelYMax,2),h(i.playbackSpeed,m.playbackSpeed,2),h(i.seed,k,0),h(i.totalTime,d.T,0),h(i.dt,d.dt,3),h(i.boxWidth,d.boxWidth,1),h(i.boxHeight,d.boxHeight,1),h(i.wallThickness,d.wallThickness,2),h(i.negX,d.negX,1),h(i.negY,d.negY,1),h(i.pointSize,m.pointSize,2),h(i.targetFps,m.targetFps,0)}function Me(){const t=l(Number(i.boxHeight.value)||v.boxHeight,20,500),e=l(Number(i.boxWidth.value)||v.boxWidth,20,500);return{T:l(Number(i.totalTime.value)||v.T,20,2e4),dt:l(Number(i.dt.value)||v.dt,.05,20),numParticles:l(Math.round(Number(i.numParticles.value)||v.numParticles),1,1e3),boxWidth:e,boxHeight:t,wallThickness:l(Number(i.wallThickness.value)||v.wallThickness,.5,50),diffusionSd:l(Number(i.diffusionSd.value)||0,0,20),channelYMin:l(Number(i.channelYMin.value)||0,-t/2,t/2),channelYMax:l(Number(i.channelYMax.value)||0,-t/2,t/2),electricStrength:l(Number(i.electricStrength.value)||0,0,10),repulsionStrength:l(Number(i.repulsionStrength.value)||0,0,10),negX:l(Number(i.negX.value)||v.negX,-e/2,e/2),negY:l(Number(i.negY.value)||v.negY,-t/2,t/2)}}function oe(){return{pointSize:l(Number(i.pointSize.value)||q.pointSize,.5,8),playbackSpeed:l(Number(i.playbackSpeed.value)||q.playbackSpeed,.1,8),targetFps:l(Math.round(Number(i.targetFps.value)||q.targetFps),1,120)}}function re(){const t=d.diffusionSd*d.dt;we.innerHTML=['<span class="accent">Euler step with drift + repulsion</span>',"attract = electric_strength · (neg_pos - pos) / (||neg_pos - pos|| + ε)","repel_j = repulsion_strength · Σ_k≠j (pos_j - pos_k) / (||pos_j - pos_k||² + ε)","x_new = x_old + (dxdt + attract_x + repel_x) · dt","y_new = clamp(y_old + (dydt + attract_y + repel_y) · dt, -H/2, H/2)","dxdt, dydt ~ Normal(0, diffusionSd²)","",'<span class="accent-2">Channel rule</span>',"Wall crossing only if y_old ∈ [channel_y_min, channel_y_max] ; else x_new := x_old","",`Per-step Brownian displacement SD = diffusionSd × dt = ${t.toFixed(3)}`,`electric_strength = ${d.electricStrength.toFixed(3)}, repulsion_strength = ${d.repulsionStrength.toFixed(3)}`].join(`
`)}function ie(t){const e=ve(u,t);T.frame.textContent=`${t+1}`,T.time.textContent=(t*u.dt).toFixed(1),T.left.textContent=`${e.left}`,T.right.textContent=`${e.right}`,T.dt.textContent=u.dt.toFixed(2),T.stepSd.textContent=(d.diffusionSd*d.dt).toFixed(3),T.seed.textContent=`${k>>>0}`,T.frames.textContent=`${u.frames}`}function V(t=!0){d=Me(),m=oe(),k=l(Math.floor(Number(i.seed.value)||k),0,4294967295)>>>0,u=se(d,k),d={...d,boxWidth:u.boxWidth,boxHeight:u.boxHeight,wallThickness:u.rightWall-u.leftWall,channelYMin:u.channelYMin,channelYMax:u.channelYMax,negX:u.negX,negY:u.negY},t&&(F=0),J(),re()}function ke(){m=oe(),J()}function de(t){K=t,z.togglePlay.textContent=K?"Pause":"Play"}J();re();ie(0);Q(U,u,0,m);z.togglePlay.addEventListener("click",()=>de(!K));z.rerun.addEventListener("click",()=>V(!0));z.rewind.addEventListener("click",()=>{F=0,ie(0),Q(U,u,0,m)});z.randomSeed.addEventListener("click",()=>{k=ne(),h(i.seed,k,0),V(!0)});z.resetDefaults.addEventListener("click",()=>{d={...v},m={...q},k=ne(),J(),V(!0),de(!0)});const Pe=["numParticles","diffusionSd","electricStrength","repulsionStrength","channelYMin","channelYMax","seed","totalTime","dt","boxWidth","boxHeight","wallThickness","negX","negY"];for(const t of Pe)i[t].addEventListener("change",()=>V(t!=="seed"));for(const t of["playbackSpeed","pointSize","targetFps"])i[t].addEventListener("change",()=>ke());window.addEventListener("resize",()=>Q(U,u,Math.floor(F),m));function ce(t){const e=(t-te)/1e3;te=t,K&&u.frames>0&&(F+=e*m.targetFps*m.playbackSpeed,F>=u.frames&&(F%=u.frames));const s=l(Math.floor(F),0,Math.max(0,u.frames-1));ie(s),Q(U,u,s,m),requestAnimationFrame(ce)}requestAnimationFrame(t=>{te=t,ce(t)});
